# Spec: Config Merger & QMK Compatibility Fix

**Feature ID:** 004-config-merger-fix  
**Status:** Planning  
**Created:** 2025-11-26  
**Priority:** High

## Problem Statement

The TUI fails to compile QMK firmware due to three critical issues:

1. **Missing RGB_MATRIX_LED_COUNT**: Keyboards using variant structures (e.g., `standard/`, `mini/`) don't have their RGB configuration loaded during compilation
2. **Deprecated VIAL Options**: Modern QMK rejects `VIAL_ENABLE` in rules.mk and `VIAL_KEYBOARD_UID` in config.h as errors
3. **Variant Path Handling**: Build system doesn't correctly handle variant subdirectories in keyboard paths

### Error Messages

```
quantum/rgb_matrix/rgb_matrix_types.h:74:23: error: 'RGB_MATRIX_LED_COUNT' undeclared
☒ keebart/corne_choc_pro: VIAL_ENABLE in rules.mk is no longer a valid option
☒ keebart/corne_choc_pro: VIAL_KEYBOARD_UID in config.h is no longer a valid option
⚠ keebart/corne_choc_pro: Build marker "keyboard.json" not found
```

## Solution Overview

Implement an **in-memory config merger** that:
- Reads keyboard base configuration files
- Detects and reads variant-specific keyboard.json files
- Extracts RGB LED count from variant configuration
- Filters deprecated VIAL options from config files
- Merges keyboard config with TUI-generated content
- Writes clean, QMK-compliant files before compilation

## Architecture

### New Module: ConfigMerger

**Location:** `src/firmware/config_merger.rs`

**Responsibilities:**
1. Parse keyboard directory structure to detect variants
2. Read and parse keyboard configuration files (config.h, rules.mk, keyboard.json)
3. Extract RGB matrix configuration from variant-specific keyboard.json
4. Filter deprecated QMK/VIAL options
5. Merge base keyboard config with TUI-generated config
6. Generate clean, modernized configuration files

### Modified Modules

**`src/firmware/generator.rs`:**
- Use ConfigMerger in `generate_merged_config_h()`
- Add `generate_sanitized_rules_mk()` method
- Update `generate()` to return 4 paths (add rules.mk)

**`src/firmware/mod.rs`:**
- Export ConfigMerger module

## Technical Design

### ConfigMerger API

```rust
pub struct ConfigMerger {
    qmk_path: PathBuf,
    keyboard: String,
    keymap: String,
}

impl ConfigMerger {
    pub fn new(qmk_path: PathBuf, keyboard: String, keymap: String) -> Self;
    
    // Variant detection
    pub fn detect_variants(&self) -> Result<Vec<String>>;
    pub fn extract_variant(&self) -> Option<String>;
    pub fn get_base_keyboard_path(&self) -> String;
    
    // File reading
    pub fn read_keyboard_config_h(&self) -> Result<String>;
    pub fn read_variant_keyboard_json(&self) -> Result<serde_json::Value>;
    pub fn read_keymap_rules_mk(&self) -> Result<Option<String>>;
    
    // Configuration extraction
    pub fn extract_rgb_led_count(&self, json: &serde_json::Value) -> Option<usize>;
    
    // Filtering & sanitization
    pub fn filter_deprecated_options(&self, config_content: String) -> String;
    pub fn sanitize_rules_mk(&self, rules_content: String) -> String;
    
    // Merging
    pub fn merge_config_h(&self, base_config: String, tui_config: String) -> Result<String>;
    pub fn generate_rules_mk(&self, base_rules: Option<String>) -> Result<String>;
}
```

### RGB LED Count Detection

**Logic:**
1. Check if keyboard path contains variant (e.g., `keebart/corne_choc_pro/standard`)
2. Read `{qmk_path}/keyboards/keebart/corne_choc_pro/standard/keyboard.json`
3. Parse `rgb_matrix.split_count` array: `[23, 23]`
4. Calculate total: `23 + 23 = 46`
5. Add to generated config.h: `#define RGB_MATRIX_LED_COUNT 46`

**JSON Structure:**
```json
{
    "rgb_matrix": {
        "split_count": [23, 23],
        "layout": [...]
    }
}
```

### Deprecated Option Filtering

**Remove from config.h:**
- `#define VIAL_KEYBOARD_UID {0x89, 0x36, ...}`
- `#define VIAL_UNLOCK_COMBO_ROWS {0, 1}`
- `#define VIAL_UNLOCK_COMBO_COLS {0, 1}`

**Remove from rules.mk:**
- `VIAL_ENABLE = yes`

**Keep in rules.mk:**
- `VIA_ENABLE = yes`
- `VIALRGB_ENABLE = yes`
- `ENCODER_MAP_ENABLE = yes`
- `CAPS_WORD_ENABLE = yes`
- `REPEAT_KEY_ENABLE = yes`

**Implementation:**
- Use regex patterns to match deprecated options
- Line-by-line filtering with comment preservation
- Maintain file formatting and structure

### Config Merging Strategy

**config.h generation:**
```
[TUI Header Comment]
// Generated by keyboard_tui
// Layout: {layout_name}
// Generated: {timestamp}

[Pragma Once]
#pragma once

[RGB Matrix LED Count if detected]
#define RGB_MATRIX_LED_COUNT 46

[Filtered Keyboard Base Config]
// Original keyboard config minus deprecated options

[TUI-Specific Additions]
// Add keymap-specific configuration here
```

**rules.mk generation:**
```
[TUI Header Comment]
# Generated by keyboard_tui

[Sanitized Existing Rules]
ENCODER_MAP_ENABLE = yes
CAPS_WORD_ENABLE = yes
REPEAT_KEY_ENABLE = yes

[TUI-Specific Rules]
# Add keymap-specific rules here
```

## Implementation Plan

### Phase 1: Create ConfigMerger Module
- [ ] Create `src/firmware/config_merger.rs`
- [ ] Implement variant detection methods
- [ ] Implement file reading methods
- [ ] Implement RGB LED count extraction
- [ ] Implement deprecated option filtering (regex-based)
- [ ] Implement config merging logic
- [ ] Add comprehensive unit tests

### Phase 2: Update FirmwareGenerator
- [ ] Import ConfigMerger in `generator.rs`
- [ ] Replace `generate_merged_config_h()` implementation
- [ ] Add `generate_sanitized_rules_mk()` method
- [ ] Update `generate()` signature to return 4 paths
- [ ] Update file writing logic for rules.mk

### Phase 3: Module Integration
- [ ] Export ConfigMerger in `src/firmware/mod.rs`
- [ ] Update builder to verify variant path handling
- [ ] Update TUI display for 4-file generation

### Phase 4: Testing
- [ ] Unit tests for ConfigMerger methods
- [ ] Integration test with keebart/corne_choc_pro/standard
- [ ] Test deprecated option filtering
- [ ] Test RGB LED count detection
- [ ] Test variant path handling
- [ ] End-to-end compilation test via TUI

## Test Cases

### Unit Tests

1. **RGB LED Count Extraction**
   - Parse split_count [23, 23] → 46
   - Parse split_count [21, 21] → 42
   - Handle missing split_count → None

2. **Deprecated Option Filtering**
   - Remove VIAL_KEYBOARD_UID from config.h
   - Remove VIAL_ENABLE from rules.mk
   - Preserve VIA_ENABLE in rules.mk
   - Preserve comments and formatting

3. **Variant Detection**
   - Detect "keebart/corne_choc_pro/standard" → Some("standard")
   - Detect "keebart/corne_choc_pro" → None
   - Extract base path from variant path

4. **Config Merging**
   - Merge without duplicates
   - Preserve #pragma once
   - Maintain logical ordering

### Integration Tests

1. **Full Generation Flow**
   - Generate all 4 files (keymap.c, vial.json, config.h, rules.mk)
   - Verify config.h has RGB_MATRIX_LED_COUNT
   - Verify config.h lacks deprecated VIAL options
   - Verify rules.mk lacks deprecated VIAL options

2. **Compilation Test**
   - Build with TUI Ctrl+B command
   - Verify compilation succeeds
   - Check firmware file is generated

## Success Criteria

- [ ] Compilation succeeds for keyboards with variants
- [ ] RGB_MATRIX_LED_COUNT is automatically defined
- [ ] No deprecated VIAL options in generated files
- [ ] All tests pass
- [ ] No regression in existing functionality
- [ ] Build log shows clean compilation (no errors/warnings about deprecated options)

## Benefits

✅ **Non-invasive**: Doesn't modify QMK source files permanently  
✅ **Automatic**: Detects variants and RGB config without user intervention  
✅ **Future-proof**: Filters deprecated options as QMK evolves  
✅ **Transparent**: Users don't need to understand the merging process  
✅ **Testable**: Each component can be unit tested independently  
✅ **Maintainable**: Logic centralized in ConfigMerger module

## Dependencies

- **serde_json**: For parsing keyboard.json files
- **regex**: For filtering deprecated options
- **std::fs**: For file I/O operations

## Risks & Mitigations

**Risk:** Breaking existing keyboard configurations  
**Mitigation:** Comprehensive test suite, non-destructive file operations

**Risk:** QMK adds new deprecated options  
**Mitigation:** Extensible regex pattern list, easy to add new patterns

**Risk:** Variant detection false positives  
**Mitigation:** Check for keyboard.json existence before treating as variant

## Future Enhancements

- Automatically convert deprecated VIAL options to modern equivalents in info.json
- Support for other QMK configuration formats
- Configuration validation before merging
- User warnings when deprecated options are detected and filtered
